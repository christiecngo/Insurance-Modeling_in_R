---
title: "sta141a project"
author: "Christie Ngo"
date: "11/28/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
insurance = read.csv("C:/Users/chris/Documents/STA 141A/insurance.csv")
insurance$smoker_status = ifelse(insurance$smoker == "Yes", 1, 0)
# insignificant: sex

insurance$smoker_status = ifelse(insurance$smoker == "yes", 1, 0)
insurance$southwest = ifelse(insurance$region == "southwest", 1, 0)
insurance$southeast = ifelse(insurance$region == "southeast", 1, 0)
insurance$northwest = ifelse(insurance$region == "northwest", 1, 0)
insurance$northeast = ifelse(insurance$region == "northeast", 1, 0) # collinear

model = lm(charges~smoker_status+sex+bmi+children+age+southwest+southeast+northwest, data=insurance)
summary(model)
par(mfrow=c(2,2))
plot(model)
```
\pagebreak

We are removing sex as a predictor variable from the overall data because the t-value of -0.394 is not significant. The p-value is 0.6933. Overall the current model explains 74.94% of the variance in charges with a residual standard error of 6062. From the plots, we can see that the quantile-quantile plot is not linear and the residuals vs. fitted values plot shows two distinct groups. We will try to subset the dataset for nonsmokers and smokers.

```{r}
# for overall dataset
outliers = rstandard(model)[rstandard(model) < -3 | rstandard(model) > 3]
indices = as.numeric(names(outliers))
leverages = hatvalues(model)
select = leverages[indices]
```


```{r}
select[leverages[indices] > ((11+1)/1388)]
```
These points are the outliers (outside of 3 standard deviations) that are also leverage points. These points will be removed from the data set after we subset based on smoker status.

```{r}
nonsmoker = insurance[insurance$smoker_status == 0,]
smoker = insurance[insurance$smoker_status == 1,]

nonsmoker_fit = lm(charges~bmi+children+age+southeast+southwest+northwest, data=nonsmoker)
outliers_ns = rstandard(nonsmoker_fit)[rstandard(nonsmoker_fit) < -3 | rstandard(nonsmoker_fit) > 3]
indices_ns = as.numeric(names(outliers_ns))
leverages_ns = hatvalues(nonsmoker_fit)
select_ns = leverages_ns[indices_ns]
high_leverage = select_ns[leverages_ns[indices_ns] > ((4+1)/1064)]

nonsmoker_clean = nonsmoker[!seq_len(nrow(nonsmoker)) %in% na.omit(as.numeric(names(high_leverage))),]
nonsmoker_fit2 = lm(charges~bmi+children+age+southeast+southwest+northwest, data=nonsmoker_clean)

summary(nonsmoker_fit2)
par(mfrow = c(2,2))
plot(nonsmoker_fit2)
```

\pagebreak
When performing linear regression, we find that BMI is no longer a significant predictor because the p-value is 0.465 and we will drop this variable. There is a lower $R^2$ value; the model only explains 40.78% of the variance in charges. To remedy this, we will choose the best transformation.

```{r}
nonsmoker_log = lm(log(charges)~children+age+southeast+southwest+northwest, data=nonsmoker_clean) # R^2 0.6812

nonsmoker_squareroot = lm(sqrt(charges)~children+age+southeast+southwest+northwest, data=nonsmoker_clean) # R^2 0.569

nonsmoker_inverse = lm((1/charges)~children+age+southeast+southwest+northwest, data=nonsmoker_clean)# R^2 0.6596

# choose LOG transformation
```


```{r}
par(mfrow=c(2,2))
plot(nonsmoker_log, main = "Log Transformation")
```

The quantile-quantile plot curves towards the end and the residual plots are not random. This model explains 68.12% of variance in charges.

```{r}
par(mfrow=c(2,2))
plot(nonsmoker_squareroot, main = "Square Root Transformation")
```

This quantile-quantile plot shoes the most curvature and the residuals still show a pattern. This model only explains 56.90% of the variance in charges.

```{r}
par(mfrow=c(2,2))
plot(nonsmoker_inverse, main = "Inverse Transformation")
```

This quantile-quantile plot now shoes curvature on both tails and the residuals show a distinct curved pattern.

We chose the log transformation with the highest $R^2$ value. The quantile-quantile curves towards the end. The residuals also show a pattern. We have not completely resolved our violations but we determined this was sufficient to move forward. Our $R^2$ value has decreased to 68.12% but the residual standard error has decreased drastically to 0.4214.


